generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int                @id @default(autoincrement())
  email             String?            @unique(map: "User_email_key")
  password          String?
  name              String?
  role              Role               @default(TENANT)
  phone             String?
  type              TenantType         @default(INDIVIDUAL)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  bedroomId         Int?
  buildingId        Int?
  companyDetails    String?            @db.Text
  companyName       String?
  firstName         String?
  inviteExpires     DateTime?
  inviteToken       String?            @unique
  lastName          String?
  unitId            Int?
  city              String?
  country           String?
  postalCode        String?
  state             String?
  street            String?
  leaseId           Int?
  parentId          Int?
  companyId         Int?
  communicationLogs CommunicationLog[]
  companyContacts   CompanyContact[]
  documents         Document[]
  insurances        Insurance[]
  invoices          Invoice[]
  leases            Lease[]            @relation("TenantLeases")
  receivedMessages  Message[]          @relation("ReceivedMessages")
  sentMessages      Message[]          @relation("SentMessages")
  properties        Property[]         @relation("ownerproperties")
  refreshTokens     RefreshToken[]
  refundAdjustments RefundAdjustment[]
  tickets           Ticket[]
  residentLease     Lease?             @relation("LeaseResidents", fields: [leaseId], references: [id])
  parent            User?              @relation("TenantResidents", fields: [parentId], references: [id])
  residents         User[]             @relation("TenantResidents")
  company           Company?           @relation("CompanyUsers", fields: [companyId], references: [id])
  quickBooksConfig  QuickBooksConfig?

  @@index([leaseId], map: "user_leaseId_fkey")
  @@index([parentId], map: "user_parentId_fkey")
  @@index([companyId], map: "user_companyId_fkey")
  @@map("user")
}

model Company {
  id               Int        @id @default(autoincrement())
  name             String     @unique
  primaryContactId Int?       
  email            String?
  phone            String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  users            User[]     @relation("CompanyUsers")
  properties       Property[] @relation("CompanyProperties")

  @@map("company")
}

model CompanyContact {
  id        Int      @id @default(autoincrement())
  companyId Int
  name      String
  email     String
  phone     String?
  role      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   User     @relation(fields: [companyId], references: [id])

  @@index([companyId], map: "companycontact_companyId_fkey")
  @@map("companycontact")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique(map: "RefreshToken_token_key")
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], map: "RefreshToken_userId_fkey")

  @@index([userId], map: "RefreshToken_userId_fkey")
  @@map("refreshtoken")
}

model Property {
  id               Int               @id @default(autoincrement())
  name             String
  address          String
  status           String            @default("Active")
  companyId        Int?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  city             String?
  civicNumber      String?
  postalCode       String?
  province         String?
  street           String?
  documents        Document[]
  maintenanceTasks MaintenanceTask[]
  owners           User[]            @relation("ownerproperties")
  company          Company?          @relation("CompanyProperties", fields: [companyId], references: [id])
  units            Unit[]

  @@index([companyId], map: "Property_companyId_fkey")
  @@map("property")
}

model Unit {
  id                Int                @id @default(autoincrement())
  name              String
  propertyId        Int
  status            String             @default("Vacant")
  bedrooms          Int                @default(1)
  rentAmount        Decimal            @default(0.000000000000000000000000000000)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  rentalMode        RentalMode         @default(FULL_UNIT)
  floor             Int?
  unitNumber        String?
  unitType          String?
  bedroomsList      Bedroom[]
  documents         Document[]
  insurances        Insurance[]
  invoices          Invoice[]
  leases            Lease[]
  refundAdjustments RefundAdjustment[]
  property          Property           @relation(fields: [propertyId], references: [id], map: "Unit_propertyId_fkey")

  @@index([propertyId], map: "Unit_propertyId_fkey")
  @@map("unit")
}

model Bedroom {
  id            Int      @id @default(autoincrement())
  bedroomNumber String
  roomNumber    Int
  unitId        Int
  status        String   @default("Vacant")
  rentAmount    Decimal  @default(0.000000000000000000000000000000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  unit          Unit     @relation(fields: [unitId], references: [id], map: "Bedroom_unitId_fkey")
  leases        Lease[]

  @@index([unitId], map: "Bedroom_unitId_fkey")
  @@map("bedroom")
}

model Lease {
  id              Int         @id @default(autoincrement())
  unitId          Int
  tenantId        Int
  startDate       DateTime?
  endDate         DateTime?
  status          String      @default("Active")
  monthlyRent     Decimal?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  securityDeposit Decimal?
  bedroomId       Int?
  leaseType       LeaseType   @default(FULL_UNIT)
  documents       Document[]
  insurances      Insurance[]
  invoices        Invoice[]
  tenant          User        @relation("TenantLeases", fields: [tenantId], references: [id], map: "Lease_tenantId_fkey")
  unit            Unit        @relation(fields: [unitId], references: [id], map: "Lease_unitId_fkey")
  bedroom         Bedroom?    @relation(fields: [bedroomId], references: [id])
  residents       User[]      @relation("LeaseResidents")

  @@index([tenantId], map: "Lease_tenantId_fkey")
  @@index([unitId], map: "Lease_unitId_fkey")
  @@index([bedroomId], map: "lease_bedroomId_fkey")
  @@map("lease")
}

model Insurance {
  id                 Int             @id @default(autoincrement())
  userId             Int
  provider           String
  policyNumber       String
  startDate          DateTime
  endDate            DateTime
  documentUrl        String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  coverageType       String?
  leaseId            Int?
  rejectionReason    String?         @db.Text
  status             InsuranceStatus @default(PENDING_APPROVAL)
  unitId             Int?
  uploadedDocumentId Int?
  user               User            @relation(fields: [userId], references: [id], map: "Insurance_userId_fkey")
  lease              Lease?          @relation(fields: [leaseId], references: [id])
  unit               Unit?           @relation(fields: [unitId], references: [id])
  document           Document?       @relation("InsuranceDocument", fields: [uploadedDocumentId], references: [id])

  @@index([userId], map: "Insurance_userId_fkey")
  @@index([leaseId], map: "insurance_leaseId_fkey")
  @@index([unitId], map: "insurance_unitId_fkey")
  @@index([uploadedDocumentId], map: "insurance_uploadedDocumentId_fkey")
  @@map("insurance")
}

model Document {
  id            Int            @id @default(autoincrement())
  userId        Int?
  name          String
  type          String
  expiryDate    DateTime?
  fileUrl       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  invoiceId     Int?
  leaseId       Int?
  propertyId    Int?
  unitId        Int?
  user          User?          @relation(fields: [userId], references: [id], map: "Document_userId_fkey")
  invoice       Invoice?       @relation(fields: [invoiceId], references: [id])
  lease         Lease?         @relation(fields: [leaseId], references: [id])
  property      Property?      @relation(fields: [propertyId], references: [id])
  unit          Unit?          @relation(fields: [unitId], references: [id])
  links         DocumentLink[]
  insuranceDocs Insurance[]    @relation("InsuranceDocument")

  @@index([userId], map: "Document_userId_fkey")
  @@index([invoiceId], map: "document_invoiceId_fkey")
  @@index([leaseId], map: "document_leaseId_fkey")
  @@index([propertyId], map: "document_propertyId_fkey")
  @@index([unitId], map: "document_unitId_fkey")
  @@map("document")
}

model DocumentLink {
  id         Int      @id @default(autoincrement())
  documentId Int
  entityType String
  entityId   Int
  document   Document @relation(fields: [documentId], references: [id])

  @@index([documentId], map: "documentlink_documentId_fkey")
  @@map("documentlink")
}

model CommunicationLog {
  id            Int      @id @default(autoincrement())
  channel       String
  eventType     String
  recipient     String
  recipientId   Int?
  relatedEntity String?
  entityId      Int?
  content       String?  @db.Text
  status        String   @default("Sent")
  timestamp     DateTime @default(now())
  recipientUser User?    @relation(fields: [recipientId], references: [id])

  @@index([recipientId], map: "communicationlog_recipientId_fkey")
  @@map("communicationlog")
}

model Ticket {
  id             Int      @id @default(autoincrement())
  userId         Int
  subject        String
  description    String
  priority       String   @default("Low")
  status         String   @default("Open")
  attachmentUrls String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  propertyId     Int?
  unitId         Int?
  category       String?
  user           User     @relation(fields: [userId], references: [id], map: "Ticket_userId_fkey")

  @@index([userId], map: "Ticket_userId_fkey")
  @@map("ticket")
}

model Invoice {
  id            Int             @id @default(autoincrement())
  invoiceNo     String          @unique(map: "Invoice_invoiceNo_key")
  tenantId      Int
  unitId        Int
  month         String
  amount        Decimal
  rent          Decimal
  serviceFees   Decimal         @default(0.000000000000000000000000000000)
  status        String          @default("draft")
  paidAt        DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  dueDate       DateTime?
  paymentMethod String?
  balanceDue    Decimal         @default(0.000000000000000000000000000000)
  paidAmount    Decimal         @default(0.000000000000000000000000000000)
  leaseId       Int?
  leaseType     String?
  category      InvoiceCategory @default(RENT)
  description   String?         @db.Text
  documents     Document[]
  tenant        User            @relation(fields: [tenantId], references: [id], map: "Invoice_tenantId_fkey")
  unit          Unit            @relation(fields: [unitId], references: [id], map: "Invoice_unitId_fkey")
  lease         Lease?          @relation(fields: [leaseId], references: [id])
  payments      Payment[]
  transactions  Transaction[]

  @@index([tenantId], map: "Invoice_tenantId_fkey")
  @@index([unitId], map: "Invoice_unitId_fkey")
  @@index([leaseId], map: "invoice_leaseId_fkey")
  @@map("invoice")
}

model Payment {
  id           Int           @id @default(autoincrement())
  invoiceId    Int
  amount       Decimal
  method       String
  reference    String?
  date         DateTime      @default(now())
  invoice      Invoice       @relation(fields: [invoiceId], references: [id])
  transactions Transaction[]

  @@index([invoiceId], map: "payment_invoiceId_fkey")
  @@map("payment")
}

model MaintenanceTask {
  id         Int       @id @default(autoincrement())
  name       String
  propertyId Int?
  type       String
  frequency  String
  dueDate    DateTime
  vendor     String
  status     String    @default("Upcoming")
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  property   Property? @relation(fields: [propertyId], references: [id], map: "MaintenanceTask_propertyId_fkey")

  @@index([propertyId], map: "MaintenanceTask_propertyId_fkey")
  @@map("maintenancetask")
}

model Transaction {
  id          Int      @id @default(autoincrement())
  date        DateTime
  description String
  type        String
  amount      Decimal
  balance     Decimal  @default(0.000000000000000000000000000000)
  status      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  accountId   Int?
  invoiceId   Int?
  paymentId   Int?
  account     Account? @relation(fields: [accountId], references: [id])
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  payment     Payment? @relation(fields: [paymentId], references: [id])

  @@index([accountId], map: "transaction_accountId_fkey")
  @@index([invoiceId], map: "transaction_invoiceId_fkey")
  @@index([paymentId], map: "transaction_paymentId_fkey")
  @@map("transaction")
}

model Communication {
  id        Int      @id @default(autoincrement())
  type      String
  recipient String
  subject   String?
  message   String
  status    String   @default("Sent")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("communication")
}

model Message {
  id         Int      @id @default(autoincrement())
  content    String   @db.Text
  senderId   Int
  receiverId Int
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  smsSid     String?  // Twilio message SID
  smsStatus  String?  // SMS delivery status: sent, delivered, failed, etc.
  sentVia    String   @default("app") // Channel: app, sms, or both
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], map: "Message_receiverId_fkey")
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], map: "Message_senderId_fkey")

  @@index([receiverId], map: "Message_receiverId_fkey")
  @@index([senderId], map: "Message_senderId_fkey")
  @@map("message")
}

model SystemSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique(map: "SystemSetting_key_key")
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("systemsetting")
}

model Tax {
  id        Int       @id @default(autoincrement())
  name      String
  rate      Decimal   @default(0.00) @db.Decimal(10, 2)
  appliesTo String    @default("Rent") @db.VarChar(50)
  status    TaxStatus @default(active)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("taxes")
}

model Account {
  id             Int           @id @default(autoincrement())
  accountName    String
  assetType      String
  openingBalance Decimal       @default(0.00) @db.Decimal(10, 2)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  transactions   Transaction[]

  @@map("accounts")
}

model RefundAdjustment {
  id        Int      @id @default(autoincrement())
  requestId String   @unique(map: "RefundAdjustment_requestId_key")
  type      String
  reason    String
  tenantId  Int
  unitId    Int
  amount    Decimal
  date      DateTime
  status    String   @default("Pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    User     @relation(fields: [tenantId], references: [id], map: "RefundAdjustment_tenantId_fkey")
  unit      Unit     @relation(fields: [unitId], references: [id], map: "RefundAdjustment_unitId_fkey")

  @@index([tenantId], map: "RefundAdjustment_tenantId_fkey")
  @@index([unitId], map: "RefundAdjustment_unitId_fkey")
  @@map("refundadjustment")
}

model RentRun {
  id           Int          @id @default(autoincrement())
  runDate      DateTime     @default(now())
  status       String       @default("PENDING")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  successCount Int          @default(0)
  failedCount  Int          @default(0)
  skippedCount Int          @default(0)
  totalAmount  Decimal      @default(0.000000000000000000000000000000)
  logs         RentRunLog[]

  @@map("rentrun")
}

model RentRunLog {
  id         Int      @id @default(autoincrement())
  rentRunId  Int
  message    String   @db.Text
  createdAt  DateTime @default(now())
  rentRun    RentRun  @relation(fields: [rentRunId], references: [id], map: "RentRunLog_rentRunId_fkey")

  @@index([rentRunId], map: "RentRunLog_rentRunId_fkey")
  @@map("rentrunlog")
}

model UnitType {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("unittype")
}

model QuickBooksConfig {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  accessToken  String?  @db.Text
  refreshToken String?  @db.Text
  realmId      String?
  
  // Config
  autoSync            Boolean @default(false)
  frequency           String  @default("realtime")
  accountFullUnitRent String?
  accountBedroomRent  String?
  accountSecurityDeposit String?
  accountLateFees     String?

  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@map("quickbooksconfig")
}

enum InsuranceStatus {
  PENDING_APPROVAL
  ACTIVE
  EXPIRING
  EXPIRED
  REJECTED
}

enum InvoiceCategory {
  RENT
  SERVICE
}

enum TenantType {
  INDIVIDUAL
  COMPANY
  RESIDENT
}

enum LeaseType {
  FULL_UNIT
  BEDROOM
}

enum Role {
  ADMIN
  OWNER
  TENANT
}

enum RentalMode {
  FULL_UNIT
  BEDROOM_WISE
}

enum TaxStatus {
  active
  inactive
}
